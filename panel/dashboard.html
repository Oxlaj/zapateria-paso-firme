<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1e293b 0%, #1e40af 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .title { font-size: 32px; font-weight: bold; color: #1f2937; }
        .subtitle { color: #6b7280; font-size: 14px; margin-top: 8px; }
        .btn { background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .upload-zone { text-align: center; padding: 80px 40px; }
        .upload-icon { font-size: 64px; margin-bottom: 20px; }
        .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .kpi { padding: 24px; border-radius: 12px; color: white; }
        .kpi-value { font-size: 32px; font-weight: bold; margin-bottom: 8px; }
        .kpi-label { font-size: 14px; opacity: 0.9; }
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .filter-group label { display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .filter-group select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { position: relative; height: 350px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f3f4f6; padding: 12px; text-align: left; font-size: 14px; font-weight: 600; color: #374151; }
        td { padding: 12px; border-top: 1px solid #e5e7eb; font-size: 14px; }
        tr:hover { background: #f9fafb; }
        .hidden { display: none; }
        @media (max-width: 768px) {
            .charts { grid-template-columns: 1fr; }
            .kpis { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="uploadScreen" class="container">
        <div class="card upload-zone">
            <div class="upload-icon">üìä</div>
            <h1 class="title" style="color: #1f2937; margin-bottom: 16px;">Sales Analytics Dashboard</h1>
            <p style="color: #6b7280; margin-bottom: 32px;">Sube tu archivo Excel para comenzar a analizar tus datos</p>
            <label class="btn">
                <input type="file" accept=".xlsx,.xls" onchange="handleFileUpload(event)" style="display: none;">
                Seleccionar Archivo Excel
            </label>
        </div>
    </div>

    <div id="dashboardScreen" class="container hidden">
        <div class="card">
            <div class="header">
                <div>
                    <h1 class="title">Sales Analytics Dashboard</h1>
                    <p class="subtitle" id="recordCount"></p>
                </div>
                <label class="btn">
                    <input type="file" accept=".xlsx,.xls" onchange="handleFileUpload(event)" style="display: none;">
                    Nuevo Archivo
                </label>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 16px; color: #1f2937;">üîç Filtros</h2>
            <div class="filters">
                <div class="filter-group">
                    <label>Pa√≠s</label>
                    <select id="countryFilter" onchange="applyFilters()"></select>
                </div>
                <div class="filter-group">
                    <label>Producto</label>
                    <select id="productFilter" onchange="applyFilters()"></select>
                </div>
                <div class="filter-group">
                    <label>A√±o</label>
                    <select id="yearFilter" onchange="applyFilters()"></select>
                </div>
                <div class="filter-group">
                    <label>Mes</label>
                    <select id="monthFilter" onchange="applyFilters()"></select>
                </div>
            </div>
        </div>

        <div class="kpis">
            <div class="kpi" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                <div class="kpi-value" id="kpiSales">$0.00M</div>
                <div class="kpi-label">Ventas Totales</div>
            </div>
            <div class="kpi" style="background: linear-gradient(135deg, #10b981, #059669);">
                <div class="kpi-value" id="kpiProfit">$0.00M</div>
                <div class="kpi-label">Ganancia Total</div>
            </div>
            <div class="kpi" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                <div class="kpi-value" id="kpiUnits">0K</div>
                <div class="kpi-label">Unidades Vendidas</div>
            </div>
            <div class="kpi" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <div class="kpi-value" id="kpiMargin">0.0%</div>
                <div class="kpi-label">Margen de Ganancia</div>
            </div>
        </div>

        <div class="charts">
            <div class="card">
                <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #1f2937;">üåç Ventas por Pa√≠s (Top 10)</h3>
                <div class="chart-container"><canvas id="countryChart"></canvas></div>
            </div>
            <div class="card">
                <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #1f2937;">üìà Tendencia Mensual</h3>
                <div class="chart-container"><canvas id="monthChart"></canvas></div>
            </div>
        </div>

        <div class="charts">
            <div class="card">
                <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #1f2937;">üì¶ Ventas por Producto</h3>
                <div class="chart-container"><canvas id="productChart"></canvas></div>
            </div>
            <div class="card">
                <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #1f2937;">üè≠ Ganancia por Fabricante</h3>
                <div class="chart-container"><canvas id="manufacturerChart"></canvas></div>
            </div>
        </div>

        <div class="card">
            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #1f2937;">üìã Datos Detallados</h3>
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Pa√≠s</th>
                            <th>Producto</th>
                            <th>Fabricante</th>
                            <th>Unidades</th>
                            <th>Ventas</th>
                            <th>Ganancia</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let charts = {};

        function parseMoneyValue(value) {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            const cleaned = String(value).replace(/[$,\s]/g, '').trim();
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '', raw: false });

                    const cleanedData = jsonData.map(row => {
                        const cleanRow = {};
                        Object.keys(row).forEach(key => {
                            const cleanKey = key.replace(/\*/g, '').trim();
                            cleanRow[cleanKey] = row[key];
                        });
                        return cleanRow;
                    });

                    allData = cleanedData.map(row => ({
                        country: String(row.Country || '').trim(),
                        product: String(row.Product || '').trim(),
                        manufacturer: String(row.Manufacturer || '').trim(),
                        unitsSold: parseMoneyValue(row['Units Sold']),
                        sales: parseMoneyValue(row.Sales),
                        profit: parseMoneyValue(row.Profit),
                        date: row.Date || '',
                        monthNumber: parseInt(row['Month Number']) || 0,
                        monthName: String(row['Month Name'] || '').trim(),
                        year: String(row.Year || '').trim()
                    })).filter(row => row.country && row.unitsSold >= 0);

                    filteredData = [...allData];
                    initializeDashboard();
                    alert(`‚úÖ ¬°√âxito! Se cargaron ${allData.length} registros.`);
                } catch (error) {
                    alert('‚ùå Error al cargar el archivo: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function initializeDashboard() {
            document.getElementById('uploadScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
            populateFilters();
            updateDashboard();
        }

        function populateFilters() {
            const countries = ['All', ...new Set(allData.map(d => d.country).filter(Boolean))].sort();
            const products = ['All', ...new Set(allData.map(d => d.product).filter(Boolean))].sort();
            const years = ['All', ...new Set(allData.map(d => d.year).filter(Boolean))].sort();
            const months = ['All', ...new Set(allData.map(d => d.monthName).filter(Boolean))];

            populateSelect('countryFilter', countries);
            populateSelect('productFilter', products);
            populateSelect('yearFilter', years);
            populateSelect('monthFilter', months);
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            select.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }

        function applyFilters() {
            const country = document.getElementById('countryFilter').value;
            const product = document.getElementById('productFilter').value;
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;

            filteredData = allData.filter(row => {
                return (country === 'All' || row.country === country) &&
                       (product === 'All' || row.product === product) &&
                       (year === 'All' || row.year === year) &&
                       (month === 'All' || row.monthName === month);
            });

            updateDashboard();
        }

        function updateDashboard() {
            updateKPIs();
            updateCharts();
            updateTable();
            document.getElementById('recordCount').textContent = 
                `${allData.length} registros totales | ${filteredData.length} mostrados`;
        }

        function updateKPIs() {
            const totalSales = filteredData.reduce((sum, row) => sum + row.sales, 0);
            const totalProfit = filteredData.reduce((sum, row) => sum + row.profit, 0);
            const totalUnits = filteredData.reduce((sum, row) => sum + row.unitsSold, 0);
            const profitMargin = totalSales > 0 ? (totalProfit / totalSales) * 100 : 0;

            document.getElementById('kpiSales').textContent = `$${(totalSales / 1000000).toFixed(2)}M`;
            document.getElementById('kpiProfit').textContent = `$${(totalProfit / 1000000).toFixed(2)}M`;
            document.getElementById('kpiUnits').textContent = `${(totalUnits / 1000).toFixed(1)}K`;
            document.getElementById('kpiMargin').textContent = `${profitMargin.toFixed(1)}%`;
        }

        function updateCharts() {
            // Sales by Country
            const countryData = {};
            filteredData.forEach(row => {
                if (!countryData[row.country]) countryData[row.country] = 0;
                countryData[row.country] += row.sales;
            });
            const topCountries = Object.entries(countryData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            createOrUpdateChart('countryChart', 'bar', {
                labels: topCountries.map(d => d[0]),
                datasets: [{
                    label: 'Ventas',
                    data: topCountries.map(d => d[1]),
                    backgroundColor: '#3b82f6'
                }]
            });

            // Sales by Month
            const monthData = {};
            filteredData.forEach(row => {
                const key = `${row.monthName}`;
                if (!monthData[key]) monthData[key] = { sales: 0, profit: 0, num: row.monthNumber };
                monthData[key].sales += row.sales;
                monthData[key].profit += row.profit;
            });
            const sortedMonths = Object.entries(monthData).sort((a, b) => a[1].num - b[1].num);

            createOrUpdateChart('monthChart', 'line', {
                labels: sortedMonths.map(d => d[0]),
                datasets: [
                    {
                        label: 'Ventas',
                        data: sortedMonths.map(d => d[1].sales),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Ganancia',
                        data: sortedMonths.map(d => d[1].profit),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }
                ]
            });

            // Sales by Product
            const productData = {};
            filteredData.forEach(row => {
                if (!productData[row.product]) productData[row.product] = 0;
                productData[row.product] += row.sales;
            });

            createOrUpdateChart('productChart', 'doughnut', {
                labels: Object.keys(productData),
                datasets: [{
                    data: Object.values(productData),
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                }]
            });

            // Profit by Manufacturer
            const mfgData = {};
            filteredData.forEach(row => {
                if (!mfgData[row.manufacturer]) mfgData[row.manufacturer] = 0;
                mfgData[row.manufacturer] += row.profit;
            });

            createOrUpdateChart('manufacturerChart', 'bar', {
                labels: Object.keys(mfgData),
                datasets: [{
                    label: 'Ganancia',
                    data: Object.values(mfgData),
                    backgroundColor: '#f59e0b'
                }]
            }, { indexAxis: 'y' });
        }

        function createOrUpdateChart(canvasId, type, data, options = {}) {
            const ctx = document.getElementById(canvasId);
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: type !== 'bar' || data.datasets.length > 1 } },
                    ...options
                }
            });
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = filteredData.slice(0, 50).map(row => `
                <tr>
                    <td>${row.country}</td>
                    <td>${row.product}</td>
                    <td>${row.manufacturer}</td>
                    <td>${row.unitsSold.toLocaleString()}</td>
                    <td>$${row.sales.toLocaleString()}</td>
                    <td>$${row.profit.toLocaleString()}</td>
                    <td>${row.date}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>